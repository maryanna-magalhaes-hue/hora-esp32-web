<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ãšltimas Leituras do ESP32</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f5f7fb; }
    .card { box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
    .table-fixed { max-height:420px; overflow:auto; display:block; }
    pre.log { height:220px; overflow:auto; background:#0b1220; color:#cfe8ff; padding:12px; border-radius:6px; }
    .badge-status-na { background:#28a745; }
    .badge-status-fora { background:#dc3545; }
    .container-top { margin-top:22px; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="container container-top">
    <div class="d-flex align-items-center justify-content-center mb-3">
      <h2 class="text-center">ðŸ“Š Ãšltimas Leituras do ESP32</h2>
    </div>

    <div class="row g-3">
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <strong>Painel de Leituras</strong>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive table-fixed">
              <table class="table table-striped mb-0">
                <thead class="table-primary">
                  <tr>
                    <th>Peso (g)</th>
                    <th>Data</th>
                    <th>Hora</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="leituras-tbody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="card">
          <div class="card-header bg-info text-white">
            <strong>Logs (monitor serial)</strong>
          </div>
          <div class="card-body">
            <pre id="logs" class="log" aria-live="polite"></pre>
            <div class="mt-2 d-flex justify-content-between">
              <small class="text-muted">AtualizaÃ§Ãµes automÃ¡ticas a cada 2.5s</small>
              <button id="limparLogs" class="btn btn-sm btn-outline-secondary">Limpar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
const DATABASE_URL = "https://horaesp32-e6279-default-rtdb.firebaseio.com";
const POLL_INTERVAL_MS = 2500;
const MAX_ROWS = 50;
const PATH = "/leituras";

const tbody = document.getElementById('leituras-tbody');
const logsEl = document.getElementById('logs');
const limparBtn = document.getElementById('limparLogs');

let seenKeys = new Set();

function buildUrl() {
  return `${DATABASE_URL}${PATH}.json?orderBy="$key"&limitToLast=${MAX_ROWS}`;
}

function formatStatusBadge(status) {
  if (!status) return '';
  if (status === 'na_cama') {
    return '<span class="badge badge-status-na text-white">NA CAMA</span>';
  } else if (status === 'saiu_da_cama') {
    return '<span class="badge badge-status-fora text-white">SAIU DA CAMA</span>';
  }
  return `<span class="badge bg-secondary">${status}</span>`;
}

function addLogLine(text) {
  const now = new Date().toLocaleTimeString();
  logsEl.textContent = `[${now}] ${text}\n` + logsEl.textContent;
}

function clearTable() {
  tbody.innerHTML = '';
}

function fillTableFromData(dataObj) {
  if (!dataObj) return;
  const items = Object.entries(dataObj).map(([k, v]) => ({ key: k, ...v }));
  items.sort((a,b) => a.key.localeCompare(b.key));
  clearTable();
  const reversed = items.slice().reverse();
  reversed.forEach(item => {
    const tr = document.createElement('tr');
    const peso = (item.peso !== undefined) ? Number(item.peso).toFixed(2) : '-';
    const data = item.data || '-';
    const hora = item.hora || '-';
    const status = item.status || '-';

    tr.innerHTML = `
      <td class="align-middle">${peso}</td>
      <td class="align-middle">${data}</td>
      <td class="align-middle">${hora}</td>
      <td class="align-middle">${formatStatusBadge(status)}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function pollOnce() {
  const url = buildUrl();
  try {
    const res = await fetch(url);
    if (!res.ok) {
      addLogLine(`Erro ao buscar leituras: HTTP ${res.status}`);
      return;
    }
    const data = await res.json();
    fillTableFromData(data);

    if (data) {
      const entries = Object.entries(data);
      entries.sort((a,b) => a[0].localeCompare(b[0]));
      for (const [key, value] of entries) {
        if (!seenKeys.has(key)) {
          seenKeys.add(key);
          const peso = (value.peso !== undefined) ? Number(value.peso).toFixed(2) : '0.00';
          const status = value.status || 'desconhecido';
          addLogLine('Enviado ao Firebase com sucesso!');
          addLogLine(`Peso: ${peso}g | Status: ${status}`);
        }
      }
    }
  } catch (err) {
    addLogLine('Erro ao conectar ao Firebase: ' + err.message);
  }
}

limparBtn.addEventListener('click', () => {
  logsEl.textContent = '';
});

async function startPolling() {
  await pollOnce();
  setInterval(pollOnce, POLL_INTERVAL_MS);
}

startPolling();
</script>
</body>
</html>
